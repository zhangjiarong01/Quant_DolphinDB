login(`admin,`123456)

use alphalens

// === Step 1: è·å–åŸå§‹æ•°æ®è¡¨ ===
t = loadTable("dfs://crypto_kline_1h", "kline_1h")

// === Step 2: åŠ è½½å› å­å®½è¡¨ ===
factor = loadTable("dfs://crypto_kline_1h", "hourfactor")
factorwide = select factor_value from factor pivot by symbol, open_time, factor_name

// === Step 3: éå†æ¯ä¸ªå› å­ ===
factorNames = schema(factorwide).colDefs.name[2:]
singleFactorTBs = array(any)


for (fname in factorNames) {
    print("ğŸ” æ­£åœ¨æµ‹è¯•å› å­ï¼š" + fname$STRING)
    sqlText1 = "select open_time as date, symbol as sym, "
    sqlText2 = " as value from factorwide"
    sqlText = sqlText1 + fname + sqlText2
    factor = parseExpr(sqlText).eval()
    price = select close from t pivot by open_time as date, symbol as sym

    try {
        factorData = get_clean_factor_and_forward_returns(factor, price, quantiles=5, periods=[1,5,10])
        
        // å°† factorData ä¿å­˜åˆ°å­—å…¸ä¸­ï¼Œkey æ˜¯ fname çš„å­—ç¬¦ä¸²å½¢å¼
        singleFactorTBs.append!(factorData)  
    } catch (ex) {
        print("âŒ å› å­å¤±è´¥ï¼š" + fname$STRING)
    }
}


// === åˆ›å»ºå› å­è¯„ä»·æŒ‡æ ‡è¡¨ ===
factorReport = table(100:0, `factor`ic_mean`ic_std`ic_sharpe, [STRING, DOUBLE, DOUBLE, DOUBLE])

for (i in 0:(size(singleFactorTBs))) {
    fData = singleFactorTBs[i]
    name = factorNames[i]
    ICSheet= create_information_tear_sheet(factor_data=fData, group_neutral=false, by_group=false)
    try {
        ic_mean = ICSheet.Information_Analysis[1,2]
        ic_std = ICSheet.Information_Analysis[4,2]
        ic_sharpe = ICSheet.Information_Analysis[2,2]
        print("æ’å…¥å› å­æŠ¥å‘Šï¼š" + name)
        insert into factorReport values(name, ic_mean, ic_std, ic_sharpe)
    } catch (ex) {
        print("âš ï¸ è·³è¿‡å› å­ï¼š" + name)
    }
}

// å…±äº«ä¾› Python è°ƒç”¨
share(factorReport, `factor_report1)

// === ä¸ºæ¯ä¸ªå› å­å…±äº«æ ¸å¿ƒåˆ†æè¡¨ ===
for (i in 0:(size(singleFactorTBs))) {
    fData = singleFactorTBs[i]
    name = factorNames[i]
    returns_tear_sheet= create_returns_tear_sheet(fData, by_group=false, long_short=true, group_neutral=false)
    try {
        share(returns_tear_sheet.cumulative_returns_by_quantile_1, `ic_ts_ + name)
    } catch (ex) {
        print("âŒ å…±äº«å¤±è´¥ï¼š" + name)
    }
}


undef(obj="momentum5h", objType=SHARED)















fData = factorData
name =`combo_reverse_amp


ICSheet= create_information_tear_sheet(factor_data=factorData, group_neutral=false, by_group=false)
try {
    ic_mean = ICSheet.Information_Analysis[1,2]
    ic_std = ICSheet.Information_Analysis[4,2]
    ic_sharpe = ICSheet.Information_Analysis[2,2]
    print("æ’å…¥å› å­æŠ¥å‘Šï¼š" + fname)
    insert into factorReport values(fname, ic_mean, ic_std, ic_sharpe)
} catch (ex) {
    print("âš ï¸ è·³è¿‡å› å­ï¼š" + fname)
}
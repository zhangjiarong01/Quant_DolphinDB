db = database("dfs://crypto_kline_1h")



// ========== åˆ›å»ºåˆ†åŒºå› å­è¡¨ ==========
if(existsTable("dfs://crypto_kline_1h", "hourfactor")){
    dropTable(db, "hourfactor")  // æ­£ç¡®è¯­æ³•ï¼šä½¿ç”¨databaseå¥æŸ„å’Œè¡¨å
    print("ğŸ—‘ï¸ å·²åˆ é™¤æ—§è¡¨ï¼šhourfactor")
}

schema = table(1:0,
    `symbol`open_time`factor_name`factor_value,  // é€šç”¨ç»“æ„
    [SYMBOL, DATETIME, SYMBOL, DOUBLE]           // ç±»å‹å®šä¹‰
)
hourfactor = db.createPartitionedTable(schema,`hourfactor, `open_time, sortColumns=`open_time)

print("âœ… æ—¶é¢‘å› å­è¡¨åˆ›å»ºæˆåŠŸï¼šdfs://crypto_kline_1h/hourfactor")



// ========== å› å­å‡½æ•° ==========
use ta

// === åŠ¨é‡å› å­ç¤ºä¾‹ï¼šè¿‡å»5å°æ—¶åŠ¨é‡ ===
def factor_momentum(closeVec, window){
    logRet = log(closeVec / move(closeVec, 1))
    return moving(sum, logRet, window)
}

// def factor_volatility(...) { ... }
// def factor_liquidity(...) { ... }
// def factor_alphaX(...) { ... }


// ========== å› å­è®¡ç®—å’Œå­˜å‚¨ ==========
t = loadTable("dfs://crypto_kline_1h", "kline_1h")

result = select open_time, symbol, close,
                factor_momentum(close, 5) as momentum5h,
                factor_momentum(close, 20) as momentum20h
from t context by symbol

// è½¬ä¸ºçª„è¡¨å­˜å‚¨
resultnarrow = unpivot(result, `symbol`open_time, `momentum5h`momentum20h) 

hourfactor.append!(resultnarrow)






// ========== åˆ›å»ºåˆ†åŒºå› å­è¡¨ ==========
db = database("dfs://crypto_kline_1h")

if(existsTable("dfs://crypto_kline_1h", "hourfactor")){
    dropTable(db, "hourfactor")  // æ­£ç¡®è¯­æ³•ï¼šä½¿ç”¨databaseå¥æŸ„å’Œè¡¨å
    print("ğŸ—‘ï¸ å·²åˆ é™¤æ—§è¡¨ï¼šhourfactor")
}

schema = table(1:0,
    `symbol`open_time`factor_name`factor_value,  // é€šç”¨ç»“æ„
    [SYMBOL, DATETIME, SYMBOL, DOUBLE]           // ç±»å‹å®šä¹‰
)
hourfactor = db.createPartitionedTable(schema,`hourfactor, `open_time, sortColumns=`open_time)

print("âœ… æ—¶é¢‘å› å­è¡¨åˆ›å»ºæˆåŠŸï¼šdfs://crypto_kline_1h/hourfactor")


// ========== å› å­è®¡ç®—å·¥å…·å‡½æ•° ==========
use ta

// é€šç”¨å·¥å…·å‡½æ•°ï¼šè®¡ç®—å¯¹æ•°æ”¶ç›Šç‡
def getLogReturn(tbl, N){
    return select open_time, symbol, log(close / prev(close)) as log_ret 
           from tbl context by symbol
}

// ========== å…·ä½“å› å­å®šä¹‰ ==========

// åŠ¨é‡å› å­
def factor_momentum(tbl, window=6){
    t = getLogReturn(tbl, window)
    return select symbol, open_time, 
                  "momentum_" + window$STRING as factor_name,
                  moving(sum, log_ret, window) as factor_value 
           from t context by symbol
}

// æ³¢åŠ¨ç‡å› å­
def factor_volatility(tbl, window=6){
    t = getLogReturn(tbl, window)
    return select symbol, open_time, 
                  "volatility_" + window$STRING as factor_name,
                  moving(std, log_ret, window) as factor_value 
           from t context by symbol
}

// åè½¬å› å­
def factor_reverse(tbl, window=6){
    t = getLogReturn(tbl, window)
    result = select symbol, open_time, 
                    "reverse_" + window$STRING as factor_name,
                    moving(sum, log_ret, window) as factor_value 
             from t context by symbol
    update result set factor_value = -1 * factor_value
    return result
}

// æŒ¯å¹…å› å­
def factor_amplitude(tbl){
    return select symbol, open_time, 
                  "amplitude" as factor_name,
                  (high - low) / close as factor_value 
           from tbl
}

// æ¢æ‰‹ç‡å› å­
def factor_turnover(tbl, window=6){
    return select symbol, open_time, 
                  "turnover_" + window$STRING as factor_name,
                  volume / moving(avg, volume, window) as factor_value 
           from tbl context by symbol
}

// VWAPåç¦»åº¦å› å­
def factor_vwap_gap(tbl){
    return select symbol, open_time, 
                  "vwap_gap" as factor_name,
                  close - (wavg(close, volume)) as factor_value 
           from tbl context by symbol
}


// ========== æ‰§è¡Œå› å­è®¡ç®— ==========
// åŠ è½½åŸå§‹Kçº¿æ•°æ®
klineData = loadTable("dfs://crypto_kline_1h", "kline_1h")
t = select open_time, symbol, close, high, low, volume 
    from klineData 
    where open_time >= 2022.01.01

// è®¡ç®—å¹¶å­˜å‚¨åŠ¨é‡å› å­
momentum = factor_momentum(t, 6)
hourfactor.append!(momentum)

// è®¡ç®—å¹¶å­˜å‚¨æ³¢åŠ¨ç‡å› å­
volatility = factor_volatility(t, 6)
hourfactor.append!(volatility)

// è®¡ç®—å¹¶å­˜å‚¨åè½¬å› å­
reverse = factor_reverse(t, 6)
hourfactor.append!(reverse)

// è®¡ç®—å¹¶å­˜å‚¨æŒ¯å¹…å› å­
amplitude = factor_amplitude(t)
hourfactor.append!(amplitude)

// è®¡ç®—å¹¶å­˜å‚¨æ¢æ‰‹ç‡å› å­
turnover = factor_turnover(t, 6)
hourfactor.append!(turnover)

// è®¡ç®—å¹¶å­˜å‚¨VWAPåç¦»åº¦å› å­
vwap_gap = factor_vwap_gap(t)
hourfactor.append!(vwap_gap)



// === ç»„åˆå› å­ ===
hourfactor = loadTable("dfs://crypto_kline_1h", "hourfactor")
wide = select factor_value from hourfactor pivot by symbol, open_time, factor_name

// === è¿”å›ä¸ºé•¿è¡¨æ ¼å¼ ===
combo = select symbol, open_time, 
                  "combo_reverse_amp" as factor_name,
                  zscore(reverse_6) + zscore(-amplitude) as factor_value 
           from wide

// === æ’å…¥åˆ°å› å­è¡¨ä¸­
hourfactor.append!(combo)

login(`admin, `123456)

// ========== å®šä¹‰æ—¶é—´åˆ†åŒºï¼ˆæŒ‰æœˆï¼‰ ==========
months = 2020.01M..2030.12M
db = database("dfs://crypto_kline_1h", VALUE, months, engine="TSDB")

// ========== è¡¨ç»“æ„ ==========
schema = table(1:0,
    `open_time`open`high`low`close`volume`close_time`quote_volume`n_trades`taker_base`taker_quote`symbol`update_time,
    [DATETIME, DOUBLE, DOUBLE, DOUBLE, DOUBLE, DOUBLE, DATETIME, DOUBLE, INT, DOUBLE, DOUBLE, SYMBOL, TIMESTAMP]
)

// ========== åˆ›å»ºåˆ†åŒºè¡¨ ==========
pt = db.createPartitionedTable(schema, `kline_1h, `open_time, sortColumns=`close_time)
print("âœ… å•å­—æ®µåˆ†åŒºè¡¨åˆ›å»ºæˆåŠŸï¼šdfs://crypto_kline_1h/kline_1h")



// ========== æ•°æ®è¡¨æ³¨é‡Š ==========

setTableComment(pt, "å¸å®‰ç°è´§Kçº¿æ•°æ®")

setColumnComment(pt, {
    open_time     : "Kçº¿å¼€ç›˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰",
    open          : "å¼€ç›˜ä»·",
    high          : "æœ€é«˜ä»·",
    low           : "æœ€ä½ä»·",
    close         : "æ”¶ç›˜ä»·",
    volume        : "æˆäº¤é‡ï¼ˆBaseèµ„äº§æ•°é‡ï¼‰",
    close_time    : "Kçº¿æ”¶ç›˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰",
    quote_volume  : "æˆäº¤é¢ï¼ˆQuoteèµ„äº§æ•°é‡ï¼‰",
    n_trades      : "æˆäº¤ç¬”æ•°",
    taker_base    : "ä¸»åŠ¨ä¹°å…¥æˆäº¤çš„Baseèµ„äº§æ•°é‡",
    taker_quote   : "ä¸»åŠ¨ä¹°å…¥æˆäº¤çš„Quoteèµ„äº§æ•°é‡",
    symbol        : "äº¤æ˜“å¯¹ï¼ˆå¦‚BTCUSDTï¼‰",
    update_time   : "å¯¼å…¥æ•°æ®æ—¶è®°å½•çš„æ›´æ–°æ—¶é—´æˆ³"
})


schema(pt).colDefs



// ========== åˆ é™¤é‡å¤å¯¼å…¥æ•°æ® ==========

login(`admin, `123456)

// 1. è½½å…¥åŸå§‹è¡¨
old = loadTable("dfs://crypto_kline_1h", "kline_1h")

// 2. åˆ é™¤é‡å¤å€¼ï¼šæŒ‰ symbol + open_time å»é‡ï¼ˆä¿ç•™æœ€å¤§ update_timeï¼‰
clean = select top 1 * from old context by symbol, open_time order by update_time desc

// 3. åˆ é™¤åŸè¡¨ï¼ˆè°¨æ…æ“ä½œï¼‰
db = database("dfs://crypto_kline_1h")
dropTable(db, `kline_1h)
print("ğŸ—‘ï¸ åŸè¡¨å·²åˆ é™¤")

// 4. é‡å»ºè¡¨ç»“æ„
schema = table(1:0,
    `open_time`open`high`low`close`volume`close_time`quote_volume`n_trades`taker_base`taker_quote`symbol`update_time,
    [DATETIME, DOUBLE, DOUBLE, DOUBLE, DOUBLE, DOUBLE, DATETIME, DOUBLE, INT, DOUBLE, DOUBLE, SYMBOL, TIMESTAMP]
)
newtbl = db.createPartitionedTable(schema, `kline_1h, `open_time, sortColumns=`close_time)
print("âœ… æ–°è¡¨å·²åˆ›å»º")

// 5. æ’å…¥å¹²å‡€æ•°æ®
newtbl.append!(clean)
print("âœ… å·²å†™å…¥å»é‡åçš„æ•°æ®ï¼Œå…±è¡Œæ•°ï¼š" + string(size(clean)))


// ========== æ•°æ®è¡¨æ³¨é‡Š ==========

setTableComment(newtbl, "å¸å®‰ç°è´§Kçº¿æ•°æ®")

setColumnComment(newtbl, {
    open_time     : "Kçº¿å¼€ç›˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰",
    open          : "å¼€ç›˜ä»·",
    high          : "æœ€é«˜ä»·",
    low           : "æœ€ä½ä»·",
    close         : "æ”¶ç›˜ä»·",
    volume        : "æˆäº¤é‡ï¼ˆBaseèµ„äº§æ•°é‡ï¼‰",
    close_time    : "Kçº¿æ”¶ç›˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰",
    quote_volume  : "æˆäº¤é¢ï¼ˆQuoteèµ„äº§æ•°é‡ï¼‰",
    n_trades      : "æˆäº¤ç¬”æ•°",
    taker_base    : "ä¸»åŠ¨ä¹°å…¥æˆäº¤çš„Baseèµ„äº§æ•°é‡",
    taker_quote   : "ä¸»åŠ¨ä¹°å…¥æˆäº¤çš„Quoteèµ„äº§æ•°é‡",
    symbol        : "äº¤æ˜“å¯¹ï¼ˆå¦‚BTCUSDTï¼‰",
    update_time   : "å¯¼å…¥æ•°æ®æ—¶è®°å½•çš„æ›´æ–°æ—¶é—´æˆ³"
})


schema(newtbl).colDefs